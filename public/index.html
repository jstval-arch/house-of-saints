<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House of Saints - Groove Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out; z-index: 10000; font-family: 'Inter', sans-serif; font-weight: 600; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Change this to your deployed server URL
        const SERVER_URL = window.location.hostname === 'localhost' 
          ? 'http://localhost:3000' 
          : window.location.origin;

        // Icons
        const Music = ({ size = 24, style }) => <svg width={size} height={size} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>;
        const Trash2 = ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Download = ({ size = 24, style }) => <svg width={size} height={size} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Sparkles = ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>;

        const storage = {
            get: (key) => { try { const item = sessionStorage.getItem(key); return item ? { value: item } : null; } catch { return null; } },
            set: (key, value) => { try { sessionStorage.setItem(key, value); return { key, value }; } catch { return null; } },
            delete: (key) => { try { sessionStorage.removeItem(key); return { deleted: true }; } catch { return null; } },
            list: (prefix) => { try { const keys = []; for (let i = 0; i < sessionStorage.length; i++) { const key = sessionStorage.key(i); if (key.startsWith(prefix)) keys.push(key); } return { keys }; } catch { return { keys: [] }; } }
        };

        const genres = [
            { id: 'rnb', name: 'R&B', color: '#E74C3C', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', image: 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=400' },
            { id: 'gospel', name: 'Gospel', color: '#F39C12', gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400' },
            { id: 'konpa', name: 'Konpa', color: '#E67E22', gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', image: 'https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?w=400' },
            { id: 'reggae', name: 'Reggae', color: '#27AE60', gradient: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', image: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=400' },
            { id: 'dancehall', name: 'Dancehall', color: '#3498DB', gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', image: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=400' },
            { id: 'afrobeat', name: 'Afrobeat', color: '#9B59B6', gradient: 'linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)', image: 'https://images.unsplash.com/photo-1571330735066-03aaa9429d89?w=400' }
        ];

        const App = () => {
            const [selectedGenre, setSelectedGenre] = useState(null);
            const [songTitle, setSongTitle] = useState('');
            const [lyrics, setLyrics] = useState('');
            const [prompt, setPrompt] = useState('');
            const [anthropicApiKey, setAnthropicApiKey] = useState('');
            const [openaiApiKey, setOpenaiApiKey] = useState('');
            const [musicGptApiKey, setMusicGptApiKey] = useState('');
            const [showApiKeyInput, setShowApiKeyInput] = useState(false);
            const [generatedTracks, setGeneratedTracks] = useState([]);
            const [isGeneratingLyrics, setIsGeneratingLyrics] = useState(false);
            const [isGeneratingMusic, setIsGeneratingMusic] = useState(false);
            const [pendingTasks, setPendingTasks] = useState([]);
            const [toast, setToast] = useState(null);
            const socketRef = useRef(null);

            // WebSocket connection
            useEffect(() => {
                const socket = io(SERVER_URL);
                socketRef.current = socket;

                socket.on('connect', () => {
                    console.log('‚úÖ Connected to server');
                });

                socket.on('music-ready', (data) => {
                    console.log('üéµ Music ready!', data);
                    
                    data.tracks.forEach(track => {
                        storage.set(`track:${track.id}`, JSON.stringify(track));
                    });
                    setGeneratedTracks(prev => [...data.tracks, ...prev]);
                    setPendingTasks(prev => prev.filter(t => t !== data.clientTaskId));
                    showToast(`üéµ ${data.tracks[0].title} is ready!`);
                });

                return () => socket.disconnect();
            }, []);

            // Load API keys and tracks
            useEffect(() => {
                const anthKey = storage.get('anthropic_api_key');
                const openKey = storage.get('openai_api_key');
                const musicKey = storage.get('musicgpt_api_key');
                if (anthKey) setAnthropicApiKey(anthKey.value);
                if (openKey) setOpenaiApiKey(openKey.value);
                if (musicKey) setMusicGptApiKey(musicKey.value);

                const trackResult = storage.list('track:');
                if (trackResult?.keys) {
                    const tracks = trackResult.keys.map(key => {
                        const data = storage.get(key);
                        return data ? JSON.parse(data.value) : null;
                    }).filter(Boolean).sort((a, b) => b.timestamp - a.timestamp);
                    setGeneratedTracks(tracks);
                }
            }, []);

            const showToast = (message) => {
                setToast(message);
                setTimeout(() => setToast(null), 4000);
            };

            const generateLyrics = async (provider) => {
                if (!prompt.trim()) { alert('Please enter a theme/prompt!'); return; }

                const apiKey = provider === 'claude' ? anthropicApiKey : openaiApiKey;
                if (!apiKey) { setShowApiKeyInput(true); alert('API Key required!'); return; }

                setIsGeneratingLyrics(true);
                try {
                    const response = await fetch(`${SERVER_URL}/api/generate-lyrics-${provider}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, genre: selectedGenre.name, [provider === 'claude' ? 'anthropicApiKey' : 'openaiApiKey']: apiKey })
                    });
                    const data = await response.json();
                    if (data.success) { setLyrics(data.lyrics); showToast(`‚ú® Lyrics generated!`); }
                    else { alert(`Error: ${data.error}`); }
                } catch (error) { alert(`Error: ${error.message}`); } finally { setIsGeneratingLyrics(false); }
            };

            const generateMusic = async () => {
                if (!musicGptApiKey) { setShowApiKeyInput(true); alert('MusicGPT API key required!'); return; }
                if (!lyrics.trim()) { alert('Add lyrics first!'); return; }

                const clientTaskId = `task-${Date.now()}`;
                setIsGeneratingMusic(true);
                setPendingTasks(prev => [...prev, clientTaskId]);

                try {
                    const response = await fetch(`${SERVER_URL}/api/generate-music`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: `Generate a ${selectedGenre.name} song`, music_style: selectedGenre.name, lyrics,
                            musicGptApiKey, taskId: clientTaskId, title: songTitle || `${selectedGenre.name} Song`
                        })
                    });
                    const data = await response.json();
                    if (data.success) { showToast(`‚úÖ Submitted! Polling...`); }
                    else { alert(`Error: ${data.error}`); setPendingTasks(prev => prev.filter(t => t !== clientTaskId)); }
                } catch (error) { alert(`Error: ${error.message}`); setPendingTasks(prev => prev.filter(t => t !== clientTaskId)); } finally { setIsGeneratingMusic(false); }
            };

            const deleteTrack = (trackId) => {
                storage.delete(`track:${trackId}`);
                setGeneratedTracks(generatedTracks.filter(track => track.id !== trackId));
            };

            return (
                <div style={{ minHeight: '100vh', background: 'linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%)', color: '#fff', fontFamily: '"Playfair Display", serif', paddingBottom: '50px' }}>
                    
                    {toast && <div className="toast">{toast}</div>}

                    <div style={{ maxWidth: '1600px', margin: '0 auto', padding: '40px 20px', position: 'relative', zIndex: 1 }}>
                        <header style={{ textAlign: 'center', marginBottom: '50px' }}>
                             <div style={{ position: 'absolute', top: '10px', right: '10px' }}>
                                <button onClick={() => setShowApiKeyInput(!showApiKeyInput)} style={{ padding: '10px 20px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', color: '#fff', cursor: 'pointer' }}>‚öôÔ∏è Settings</button>
                            </div>

                             {showApiKeyInput && (
                                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.9)', zIndex: 999, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <div style={{ background: '#1a1a2e', padding: '40px', borderRadius: '20px', minWidth: '400px', border: '1px solid #333' }}>
                                        <h3 style={{ marginBottom: '20px' }}>API Keys</h3>
                                        <input type="password" placeholder="Anthropic Key" value={anthropicApiKey} onChange={(e) => {setAnthropicApiKey(e.target.value); storage.set('anthropic_api_key', e.target.value)}} style={{ width: '100%', marginBottom: '15px', padding: '10px' }} />
                                        <input type="password" placeholder="OpenAI Key" value={openaiApiKey} onChange={(e) => {setOpenaiApiKey(e.target.value); storage.set('openai_api_key', e.target.value)}} style={{ width: '100%', marginBottom: '15px', padding: '10px' }} />
                                        <input type="password" placeholder="MusicGPT Key" value={musicGptApiKey} onChange={(e) => {setMusicGptApiKey(e.target.value); storage.set('musicgpt_api_key', e.target.value)}} style={{ width: '100%', marginBottom: '15px', padding: '10px' }} />
                                        <button onClick={() => setShowApiKeyInput(false)} style={{ width: '100%', padding: '12px', background: '#667eea', border: 'none', color: '#fff', borderRadius: '8px', cursor: 'pointer' }}>Done</button>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'inline-flex', alignItems: 'center', gap: '15px' }}>
                                <Music size={48} style={{ color: '#ff6b9d' }} />
                                <h1 style={{ fontSize: '56px', margin: 0, background: 'linear-gradient(135deg, #ff6b9d, #c471f5, #12c2e9)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>House of Saints</h1>
                            </div>
                        </header>

                        <div style={{ display: 'flex', gap: '15px', marginBottom: '40px', overflowX: 'auto', paddingBottom: '10px' }}>
                            {genres.map((genre) => (
                                <div key={genre.id} onClick={() => setSelectedGenre(genre)} style={{ minWidth: '200px', height: '120px', borderRadius: '16px', position: 'relative', cursor: 'pointer', border: selectedGenre?.id === genre.id ? `2px solid ${genre.color}` : '2px solid transparent', overflow: 'hidden' }}>
                                    <div style={{ position: 'absolute', inset: 0, background: `url(${genre.image}) center/cover` }} />
                                    <div style={{ position: 'absolute', inset: 0, background: 'rgba(0,0,0,0.5)' }} />
                                    <div style={{ position: 'absolute', bottom: '10px', left: '15px', fontWeight: 'bold', fontSize: '20px' }}>{genre.name}</div>
                                </div>
                            ))}
                        </div>

                        {selectedGenre && (
                            <div style={{ background: 'rgba(255,255,255,0.05)', padding: '30px', borderRadius: '20px', marginBottom: '40px' }}>
                                <input type="text" placeholder="Title" value={songTitle} onChange={(e) => setSongTitle(e.target.value)} style={{ width: '100%', padding: '15px', marginBottom: '15px', background: 'rgba(0,0,0,0.3)', border: '1px solid #444', color: '#fff', borderRadius: '8px' }} />
                                <input type="text" placeholder="Theme/Prompt" value={prompt} onChange={(e) => setPrompt(e.target.value)} style={{ width: '100%', padding: '15px', marginBottom: '15px', background: 'rgba(0,0,0,0.3)', border: '1px solid #444', color: '#fff', borderRadius: '8px' }} />
                                
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
                                    <button onClick={() => generateLyrics('claude')} disabled={isGeneratingLyrics} style={{ flex: 1, padding: '12px', background: '#667eea', border: 'none', borderRadius: '8px', color: '#fff', cursor: 'pointer', opacity: isGeneratingLyrics ? 0.5 : 1 }}>Generate Lyrics (Claude)</button>
                                    <button onClick={() => generateLyrics('openai')} disabled={isGeneratingLyrics} style={{ flex: 1, padding: '12px', background: '#10b981', border: 'none', borderRadius: '8px', color: '#fff', cursor: 'pointer', opacity: isGeneratingLyrics ? 0.5 : 1 }}>Generate Lyrics (GPT-4)</button>
                                </div>

                                <textarea value={lyrics} onChange={(e) => setLyrics(e.target.value)} style={{ width: '100%', height: '200px', background: 'rgba(0,0,0,0.3)', border: '1px solid #444', color: '#fff', padding: '15px', borderRadius: '8px', marginBottom: '20px' }} />
                                
                                <button onClick={generateMusic} disabled={isGeneratingMusic} style={{ width: '100%', padding: '15px', background: selectedGenre.gradient, border: 'none', borderRadius: '8px', color: '#fff', fontSize: '18px', fontWeight: 'bold', cursor: 'pointer', opacity: isGeneratingMusic ? 0.5 : 1 }}>
                                    {isGeneratingMusic ? 'Generating...' : 'üéµ Generate Music'}
                                </button>
                                
                                {pendingTasks.length > 0 && <div style={{ marginTop: '15px', color: '#818cf8', textAlign: 'center' }}>‚è≥ Processing...</div>}
                            </div>
                        )}

                        {generatedTracks.length > 0 && (
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px' }}>
                                {generatedTracks.map((track) => {
                                    // THIS IS THE PROXY MAGIC
                                    const proxyUrl = `${SERVER_URL}/api/proxy-audio?url=${encodeURIComponent(track.audio_url)}`;
                                    
                                    return (
                                        <div key={track.id} style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '16px', overflow: 'hidden' }}>
                                            <div style={{ height: '200px', background: `url(${track.album_art}) center/cover`, position: 'relative' }}>
                                                <button onClick={() => deleteTrack(track.id)} style={{ position: 'absolute', top: '10px', right: '10px', background: 'rgba(0,0,0,0.8)', border: 'none', borderRadius: '50%', width: '30px', height: '30px', color: '#ff4444', cursor: 'pointer' }}><Trash2 size={16}/></button>
                                            </div>
                                            <div style={{ padding: '20px' }}>
                                                <h3 style={{ fontSize: '18px', marginBottom: '5px' }}>{track.title}</h3>
                                                <p style={{ fontSize: '12px', color: '#aaa', marginBottom: '15px' }}>{track.genre}</p>
                                                
                                                <audio controls style={{ width: '100%', marginBottom: '10px' }}>
                                                    <source src={proxyUrl} />
                                                </audio>
                                                
                                                <a href={proxyUrl} target="_blank" download={`${track.title}.mp3`} style={{ display: 'block', textAlign: 'center', padding: '10px', background: 'rgba(255,255,255,0.1)', color: '#fff', textDecoration: 'none', borderRadius: '8px', fontSize: '14px' }}>
                                                    <Download size={14} style={{ marginRight: '5px', verticalAlign: 'middle' }}/> Download
                                                </a>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>